<script setup lang="ts">
import debounce from 'debounce';

import Button from 'primevue/button';
import Card from 'primevue/card';
import InputText from 'primevue/inputtext';

import AppState, { AppPage } from '../types/AppState'

defineProps({
	appState: {
		type: AppState,
		required: true,
	}
});
</script>

<template>
<div @paste="onPaste">
	<h1>Step 1. Select a template</h1>

	<Card>
		<template #title>
			Please provide a template image
		</template>
		<template #content>
			<div class="image-placeholder" @drop="onFileDrop" @dragover="onFileDragOver">
				<div>
					Please drag-and-drop an image here, press the <a href="#" @click="onBrowseClick">browse</a> button, or paste an image from clipboard (ctrl/cmd+V)
				</div>
			</div>
			
			<div class="margin-top-min">
				As an option, you can provide an image URL below:
				<InputText id="remoteUrl" type="text" class="margin-top-min" style="width: 100%" @keydown="onInputUpdate"
					placeholder="Examples: https://example.com/my/image.png; d:\images\my_image\png; /home/me/my_image.png"
					v-model="filePath" autofocus="true"/>
			</div>
		</template>
	</Card>

	<Card>
		<template #title>
			Preview
		</template>
		<template #content>
			<div v-if="!fileContent">
				No preview available at this point.
			</div>
			<img v-if="fileContent" v-bind:src="'data:image/png;base64, ' + fileContent" />
		</template>
	</Card>

	<div class="margin-top-min">
		<Button @click="onProceedClick" icon="pi pi-forward" iconPos="left" label="Proceed" style="float:right" :disabled="!fileContent"></Button>
	</div>
</div>
</template>

<style scoped>
.margin-top-min {
	margin-top: 1rem;
}

.image-placeholder {
	border: 3px dashed gray;
	width: 100%;
	min-height: 10rem;
	display: flex;
	justify-content: center;
	align-content: center;
	flex-direction: column;
	text-align: center;
	padding: 1rem;
	
}
</style>

<script lang="ts">
const { ipcRenderer } = require("electron");

const blobToBase64 = (blob: Blob): Promise<string> => new Promise((resolve, reject) => {
  const reader = new FileReader();
  reader.readAsDataURL(blob);
  reader.onload = () => resolve((reader.result || '').toString());
  reader.onerror = error => reject(error);
});

export default {
	methods: {
		loadImageFromPath: function() {
			// Empty or no path separators found
			if ('' === this.filePath || (-1 === this.filePath.indexOf('/') && -1 === this.filePath.indexOf('\\'))) {
				return;
			}

			ipcRenderer
				.invoke("loadImageAsBase64", this.filePath)
				.then(result => this.fileContent = result);
		},
		onBrowseClick: function(e: MouseEvent) {
			e.preventDefault();
			ipcRenderer
				.invoke("showOpenDialog")
				.then((e: Electron.OpenDialogReturnValue) => {
				if (e.canceled || 0 === e.filePaths.length) {
					return;
				}

				this.filePath = e.filePaths[0];
				this.loadImageFromPath();
			});

		},
		onFileDragOver: function(e: DragEvent) {
			e.preventDefault();
		},
		onFileDrop: function(e: DragEvent) {
			e.preventDefault();
			const files = (e.dataTransfer || {}).files || [];
			const file = files.length ? files[0] : null;
			if (!file) {
				return;
			}

			this.filePath = file.path;
		},
		onInputUpdate: debounce(function(this: any, e: Event) {
			this.loadImageFromPath();
		}, 1000),
		onPaste: async function() {
			const items = await navigator.clipboard.read();
			items.forEach(item => {
				item.types.forEach(async type => {
					if (!type.startsWith("image/")) {
						return;
					}
					const imageBlob = await item.getType(type);
					let imageContent = await blobToBase64(imageBlob);
					if (imageContent.startsWith('data:')) {
						const pos = imageContent.search(',');
						imageContent = imageContent.substring(pos + 1);
					}
					this.fileContent = imageContent;
				});
			});
		},
		onProceedClick: function(e: MouseEvent) {
			e.preventDefault();
			// this.appState.page = AppPage.Edit;
		},
	},
	data() {
		const result: { filePath: string, fileContent: string|null } = {
			filePath: '',
			fileContent: null,
		}
		return result;
	}
}
</script>